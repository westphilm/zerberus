flush ruleset

table ip filter {
  counter c_dns_fwd_drop        { }
  counter c_dot_client_drop     { }
  counter c_drop_generic        { }
  counter c_fwd_vpn             { }
  counter c_fwd_wan             { }
  counter c_fwd_pi              { }
  counter c_wan_local           { }
  counter c_wan_public          { }
  counter c_dns50               { }
  counter c_dns1                { }
  counter c_dot50               { }
  counter c_dot1                { }

  chain INPUT {
    type filter hook input priority filter; policy accept;

    # DNS requests
    #
    ip saddr 192.168.50.0/24 udp dport 53 counter name c_dns50
    ip saddr 192.168.50.0/24 tcp dport 53 counter name c_dns50
    ip saddr 192.168.1.0/24  udp dport 53 counter name c_dns1
    ip saddr 192.168.1.0/24  tcp dport 53 counter name c_dns1

    # DoT requests
    #
    ip saddr 192.168.50.0/24 udp dport 853 counter name c_dot50
    ip saddr 192.168.50.0/24 tcp dport 853 counter name c_dot50
    ip saddr 192.168.1.0/24  udp dport 853 counter name c_dot1
    ip saddr 192.168.1.0/24  tcp dport 853 counter name c_dot1


    ## das lassen wir mal offen..
    ## iifname "eth1" ip saddr 192.168.50.0/24 ip daddr 192.168.1.2 drop

    # DoT #853 wird nicht mehr verwendet
    # iifname "eth0" tcp dport 853 ct state established,new accept

    # dnsmasq dhcp eth0 #67
    iifname "eth0" udp dport 67 accept
    # dnsmasq dhcp eth1 #67
    iifname "eth1" udp dport 67 accept

    iifname "eth0" udp dport 51821 accept comment "WireGuard wg0"
    iifname "wg0" icmp type echo-request accept comment "WG ping -> Pi"

    iifname "wg0" udp dport 53 accept comment "WG DNS/UDP -> Pi-hole"

    # DoTc#853 via WG wird nicht verwendet..
    ## iifname "wg0" tcp dport { 53, 853 } accept comment "WG DNS/TCP/DoT -> Pi-hole"
    iifname "wg0" tcp dport { 53 } accept comment "WG DNS/TCP -> Pi-hole"
  }

  chain OUTPUT {
    type filter hook output priority filter; policy accept;
  }


  chain FORWARD {
    type filter hook forward priority filter; policy drop;

    # eth0-Split (Local vs Internet) – FORWARD, beide Richtungen, nur zählen
    iifname { "eth1", "wg0" } oifname "eth0" ip daddr 192.168.1.0/24 counter name c_wan_local
    iifname "eth0"           oifname { "eth1", "wg0" } ip saddr 192.168.1.0/24 counter name c_wan_local
    iifname { "eth1", "wg0" } oifname "eth0" ip daddr != 192.168.1.0/24 counter name c_wan_public
    iifname "eth0"           oifname { "eth1", "wg0" } ip saddr != 192.168.1.0/24 counter name c_wan_public


    ## Pi & Guest Traffic zählen

    # Pi → VPN (hin & zurück)
    #iifname { "eth0","eth1","wg0" } oifname "nordlynx" counter name c_fwd_pi
    #iifname "nordlynx" oifname { "eth0","eth1","wg0" } counter name c_fwd_pi
    iifname { "eth1","wg0","eth0" } oifname "nordlynx" counter name c_fwd_pi
    iifname "nordlynx" oifname { "eth1","wg0","eth0" } counter name c_fwd_pi


    # Kill-Switch: LAN/WG darf nicht ins Internet über eth0 (außer 192.168.1.0/24)
    iifname { "eth1", "wg0" } oifname "eth0" ip daddr != 192.168.1.0/24 counter name c_drop_generic drop

    # Pi → WAN direkt (eth0 Internet, 1er-Netz ausgeschlossen) – hin & zurück
    #iifname { "eth0","eth1","wg0" } oifname "eth0" ip daddr != 192.168.1.0/24 counter name c_fwd_pi
    #iifname "eth0" oifname { "eth0","eth1","wg0" } ip saddr != 192.168.1.0/24 counter name c_fwd_pi
    iifname { "eth1","wg0" } oifname "eth0" ip daddr != 192.168.1.0/24  counter name c_fwd_pi
    iifname "eth0" oifname { "eth1","wg0" } ip saddr != 192.168.1.0/24  counter name c_fwd_pi

    # wg forward
    iifname "wg0" oifname "eth0" ct state new,established accept
    iifname "eth0" oifname "wg0" ct state established,related accept

    # DNS in FORWARD (Ziel ≠ Pi) -> zählen und blocken, um DNS-Leaks zu verhindern
    # (hier bewusst DROP, kein Accept-Fall)
    iifname { "eth0", "eth1" } tcp dport 53 ip daddr != { 192.168.1.2, 192.168.50.1 } counter name c_dns_fwd_drop drop
    iifname { "eth0", "eth1" } udp dport 53 ip daddr != { 192.168.1.2, 192.168.50.1 } counter name c_dns_fwd_drop drop


    # DoT-Clients (TCP/853) -> zählen + DROPPEN
    iifname { "eth0", "eth1" } ip saddr { 192.168.1.0/24, 192.168.50.0/24 } tcp dport 853 counter name c_dot_client_drop drop

    # --- deine erlaubten Pfade (bereinigt) ---
    iifname "eth1" oifname "eth0" ip saddr 192.168.50.0/24 accept
    iifname "eth0" oifname "eth1" ip daddr 192.168.50.0/24 ct state established,related accept

    iifname "eth0" oifname "eth0" ip saddr 192.168.1.0/24 accept
    iifname "eth0" oifname "eth0" ct state established,related accept

    iifname "eth0" oifname "eth1" ip saddr 192.168.1.0/24 ip daddr 192.168.50.0/24 accept
    iifname "eth1" oifname "eth0" ip saddr 192.168.50.0/24 ip daddr 192.168.1.0/24 ct state established,related accept

    iifname "wg0" oifname "eth1" accept comment "WG→LAN"
    iifname "eth1" oifname "wg0" ct state established,related accept

    iifname "eth1" oifname "nordlynx" ip saddr 192.168.50.0/24 accept
    iifname "nordlynx" oifname "eth1" ct state established,related accept

    iifname "eth0" oifname "nordlynx" ip saddr 192.168.1.0/24 accept
    iifname "nordlynx" oifname "eth0" ct state established,related accept

    iifname "wg0" oifname "nordlynx" accept
    iifname "nordlynx" oifname "wg0" ct state established,related accept
  }


}

#############################
# Policy Routing Markierung #
#############################
table ip marking {
  chain prerouting_mark {
    type filter hook prerouting priority mangle; policy accept;
    # DoT → novpn
    # DoT wird nicht mehr verwendet
    # iifname "eth0" tcp dport 853 meta mark set 0x00000355 comment "DoT → novpn"
    # iifname "eth0" tcp dport 853 ct   mark set 0x00000355 comment "DoT → novpn"
    # WG replies markieren
    ct mark 0x00000520 meta mark set ct mark comment "WG reply mark"
    iifname "wg0" ct   mark set 0x00000520
    iifname "wg0" meta mark set 0x00000520
  }

  # DoT wird nicht mehr verwendet
  # chain output_mark {
  #   type route hook output priority mangle; policy accept;
  #   ip daddr 10.6.0.0/24 return comment "Bypass mark for WG replies"
  #   ct mark 0x00000355 meta mark set ct mark
  # }

  # Unbound-Anfragen über WAN statt nordlynx:
  #chain output_mark {
  #  type route hook output priority mangle; policy accept;
  #  meta skuid "unbound" meta mark set 0x00000077 comment "Unbound → WAN"
  #}
  # Unbound-Anfragen über nordlynx statt WAN:
  # Falls NordVPN inaktiv: „VPN-down“-Regelsatz routet pref 110 fwmark 0x520 aktuell
  # nach WAN. D. h. Unbound fällt auf WAN zurück (soft-fail).
  #chain output_mark {
  #  type route hook output priority mangle; policy accept;
  #  meta skuid "unbound" counter meta mark set 0x00000520 comment "Unbound → VPN"
  #}
}

# MSS-Clamp (rt-mtu) — bewusst NICHT im Table 'ip mangle', um Telio nicht zu stören
table ip tune {
  chain fwd_mss {
    type filter hook forward priority mangle; policy accept;
    oifname "nordlynx" tcp flags syn / syn,rst tcp option maxseg size set rt mtu
    iifname "wg0"      tcp flags syn / syn,rst tcp option maxseg size set rt mtu
  }
}

table ip nat {
  counter c_masq_vpn_bytes { }
  counter c_masq_wan_bytes { }
  #counter c_wan_local { }
  #counter c_wan_public { }
  counter c_nat_hits { }

  counter c_masq_wan_public_bytes { }

  chain PREROUTING  { type nat hook prerouting  priority dstnat; policy accept; }
  chain POSTROUTING {
    type nat hook postrouting priority srcnat; policy accept;

    # Gesamt-NAT-Volumen (nur zählen)
    oifname != "lo" counter name c_nat_hits

    # VPN-Masquerade (NordLynx)
    oifname "nordlynx" counter name c_masq_vpn_bytes masquerade

    # WAN-Fallback (eth0) — nur wenn wirklich ins Internet über eth0 gegangen wird
    oifname "eth0"     counter name c_masq_wan_bytes masquerade

    # WAN Public (Internet) NAT counter – muss bei Kill-Switch 0 bleiben
    oifname "eth0" ip daddr != 192.168.1.0/24 counter name c_masq_wan_public_bytes masquerade

    # Fallbacks über WAN (gezielt, keine catch-all NAT)
    oifname "eth0" ip saddr 192.168.50.0/24 masquerade comment "LAN → Internet (Fallback)"
    oifname "eth0" ip saddr 10.6.0.0/24     masquerade comment "Handy → Internet (Fallback)"
    # NordVPN
    oifname "nordlynx" ip saddr 192.168.50.0/24 masquerade comment "LAN → NordVPN"
    oifname "nordlynx" ip saddr 10.6.0.0/24     masquerade comment "Handy → NordVPN"
    # neu:
    # 1er Netz -> NordVPN
    # oifname "nordlynx" ip saddr 192.168.1.0/24 masquerade comment "1er Netz → NordVPN"
    # 1er Netz -> WAN (Fallback)
    # oifname "eth0" ip saddr 192.168.1.0/24 masquerade comment "1er Netz → Internet (Fallback)"

    ### Zaehler / Monitoring
    ##

    # Gesamtzähler für NAT (optional)
    # oifname != "lo" counter name c_nat_hits
    # VPN-Masquerade (NordLynx)
    # oifname "nordlynx" counter name c_masq_vpn_bytes masquerade
    # WAN-Fallback (eth0)
    # oifname "eth0"     counter name c_masq_wan_bytes masquerade
  }
}
